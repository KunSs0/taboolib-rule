# I18n 模块

## 概述
I18n (国际化) 模块提供多语言支持功能，允许插件支持多种语言，提升用户体验。

## 功能特性
- 多语言文件管理
- 动态语言切换
- 占位符支持
- 语言文件热重载
- 默认语言回退
- **顶级扩展函数：sendInfo/sendWarn/sendError**
- 跨平台支持 (CommandSender, Player, ProxyCommandSender, ProxyPlayer)

## 安装配置
在 `build.gradle.kts` 中配置：
```kotlin
taboolib {
    env {
        install(I18n)
    }
}
```

## 顶级扩展函数

TabooLib I18n 提供了便捷的顶级扩展函数，可以直接在各种发送者对象上调用：

### 支持的发送者类型
- **CommandSender** (Bukkit 原生)
- **Player** (Bukkit 玩家)
- **ProxyCommandSender** (TabooLib 跨平台)
- **ProxyPlayer** (TabooLib 跨平台玩家)

### 三种消息类型函数

**⚠️ 重要：正确的参数传递方式**

TabooLib I18n 使用**数字占位符**和**按序传参**，而不是命名占位符和键值对：

```kotlin
import taboolib.module.lang.*

// 正确的方式 ✅
player.sendInfo("purchaseSuccess", "钻石剑", 100)
sender.sendInfo("teleportSuccess", targetPlayer.name)

// 警告消息 (通常为黄色/警示消息)
player.sendWarn("lowBalance", balance, cost)
sender.sendWarn("limitedAccess")

// 错误消息 (通常为红色/错误消息)
player.sendError("playerNotFound", targetName)
sender.sendError("insufficientPermissions")
```

**❌ 错误的方式（不要这样使用）：**
```kotlin
// 错误：使用键值对传参
player.sendInfo("purchaseSuccess", "item" to "钻石剑", "price" to 100)
player.sendWarn("lowBalance", "current" to balance, "required" to cost)
```

### 语言文件配置
配合顶级函数使用的语言文件结构：

**⚠️ 重要：使用数字占位符格式**

**zh_CN.yml** (正确格式 ✅):
```yaml
# 商店消息 - 使用数字占位符
purchaseSuccess: "&a成功购买 {0}，花费 {1} 金币！"

# 经济消息
lowBalance: "&e余额不足！当前: &c{0}&e，需要: &c{1}"

# 命令消息
teleportSuccess: "&a已传送到 {0}！"

# 权限消息
limitedAccess: "&e你的权限有限，部分功能可能不可用"

# 错误消息
playerNotFound: "&c找不到玩家: {0}"
insufficientPermissions: "&c权限不足，无法执行此操作！"
```

**❌ 错误格式（不要使用命名占位符）：**
```yaml
# 错误：使用命名占位符
purchaseSuccess: "&a成功购买 {item}，花费 {price} 金币！"
lowBalance: "&e余额不足！当前: &c{current}&e，需要: &c{required}"
teleportSuccess: "&a已传送到 {target}！"
playerNotFound: "&c找不到玩家: {name}"
```

### 实际项目示例

以下是本项目中的实际使用示例：

**语言文件格式对比：**
```yaml
# ❌ 旧格式（错误）
signSuccess: "&a签到成功！连续签到 {consecutiveDays} 天，总计签到 {totalSigns} 次"
adminPlayerNotFound: "&c找不到玩家：{player}"

# ✅ 新格式（正确）
signSuccess: "&a签到成功！连续签到 {0} 天，总计签到 {1} 次"
adminPlayerNotFound: "&c找不到玩家：{0}"
```

**代码调用对比：**
```kotlin
// ❌ 旧方式（错误）
adaptPlayer(player).sendInfo("signSuccess",
    "consecutiveDays" to days,
    "totalSigns" to total
)

// ✅ 新方式（正确）
adaptPlayer(player).sendInfo("signSuccess", days, total)
```

## 基本用法

### 语言文件结构
在 `src/main/resources/lang/` 目录下创建语言文件：

**zh_CN.yml** (中文):
```yaml
# 基础消息 - 使用数字占位符
welcomeMessage: "&a欢迎来到服务器，{0}！"
goodbyeMessage: "&c再见，{0}！"
noPermission: "&c你没有权限执行此操作！"

# 错误消息
playerNotFound: "&c未找到玩家: {0}"
invalidNumber: "&c无效的数字: {0}"

# 命令消息
commandHelp: "&e命令帮助："
reloadSuccess: "&a配置重载成功！"
```

**en_US.yml** (英文):
```yaml
# Basic messages - 使用数字占位符
welcomeMessage: "&aWelcome to the server, {0}!"
goodbyeMessage: "&cGoodbye, {0}!"
noPermission: "&cYou don't have permission to perform this action!"

# Error messages
playerNotFound: "&cPlayer not found: {0}"
invalidNumber: "&cInvalid number: {0}"

# Command messages
commandHelp: "&eCommand Help:"
reloadSuccess: "&aConfiguration reloaded successfully!"
```

### 基本消息发送
```kotlin
import taboolib.module.lang.*

// 正确方式：使用顶级扩展函数发送消息 ✅
player.sendInfo("welcomeMessage", player.name)
player.sendWarn("warningMessage")
player.sendError("noPermission")

// 对于 ProxyCommandSender (跨平台)
sender.sendInfo("commandSuccess")
sender.sendWarn("commandWarning")
sender.sendError("commandError")

// 传统方式 - 发送语言消息（也使用按序传参）
player.sendLang("welcomeMessage", player.name)

// 获取语言文本
val welcomeMessage = player.asLangText("welcomeMessage", player.name)
player.sendMessage(welcomeMessage)

// ❌ 错误方式（不要使用键值对）
// player.sendInfo("welcomeMessage", "player" to player.name)
// player.sendLang("welcomeMessage", "player" to player.name)
```

### 多参数消息
```kotlin
// 语言文件中的消息（使用数字占位符）
// transferSuccess: "&a成功转账 {0} 金币给 {1}！"

player.sendLang("transferSuccess", 1000, targetPlayer.name)

// ❌ 错误方式
// player.sendLang(
//     "transferSuccess",
//     "amount" to 1000,
//     "target" to targetPlayer.name
// )
```

### 错误处理
```kotlin
import taboolib.module.lang.Language

// 检查语言键是否存在
if (Language.hasKey("customError")) {
    player.sendLang("customError")
} else {
    player.sendMessage("§c发生了未知错误！")
}

// 使用默认值
val message = player.asLangText("unknownError", default = "§c未知错误")
```

## 高级功能

### 动态语言切换
```kotlin
import taboolib.module.lang.Language

// 设置玩家语言
Language.setPlayerLanguage(player, "en_US")

// 获取玩家当前语言
val currentLang = Language.getPlayerLanguage(player)
player.sendMessage("§e当前语言: $currentLang")

// 临时使用指定语言（也使用按序传参）
val englishMessage = Language.getTextWithLanguage("en_US", "welcomeMessage", player.name)
```

### 列表消息
```yaml
# 语言文件
shopItemList:
  - "&e=== 商店物品列表 ==="
  - "&f1. 钻石剑 - &a100金币"
  - "&f2. 钻石镐 - &a80金币"
  - "&f3. 钻石甲 - &a200金币"
  - "&e====================="
```

```kotlin
// 发送列表消息
player.sendLang("shopItemList")

// 获取列表消息
val itemList = player.asLangTextList("shopItemList")
itemList.forEach { line ->
    player.sendMessage(line)
}
```

### 条件消息
```yaml
# 语言文件（使用数字占位符）
balanceHigh: "&a你的余额很充足: {0} 金币"
balanceMedium: "&e你的余额: {0} 金币"
balanceLow: "&c余额不足: {0} 金币"
```

```kotlin
// 代码中使用
val balance = getPlayerBalance(player)
val messageKey = when {
    balance >= 10000 -> "balanceHigh"
    balance >= 1000 -> "balanceMedium"
    else -> "balanceLow"
}

player.sendLang(messageKey, balance)
```

### 复杂占位符
```yaml
# 语言文件（使用数字占位符）
playerInfo: |
  &e=== 玩家信息 ===
  &f姓名: &a{0}
  &f等级: &b{1}
  &f经验: &d{2}/{3}
  &f生命值: &c{4}/{5}
  &f金币: &e{6}
  &e================
```

```kotlin
player.sendLang("playerInfo",
    player.name,
    player.level,
    player.exp,
    player.expToLevel,
    player.health.toInt(),
    player.maxHealth.toInt(),
    getPlayerMoney(player)
)
```

### 语言文件管理
```kotlin
import taboolib.module.lang.Language

// 重载语言文件
Language.reload()

// 添加自定义语言文件路径
Language.addLanguageFile("custom/messages.yml")

// 设置默认语言
Language.setDefaultLanguage("zh_CN")
```

## 实用示例

### 命令中的多语言支持
```kotlin
@CommandBody
object MultiLangCommand {

    @CommandHeader(name = "money")
    fun main(sender: ProxyCommandSender) {
        if (sender !is Player) {
            sender.sendError("playerOnly") // 使用 sendError
            return
        }

        val balance = getPlayerBalance(sender)
        sender.sendInfo("commandBalance", balance) // 使用 sendInfo（按序传参）
    }

    @SubCommand("pay")
    fun pay(
        sender: ProxyCommandSender,
        @CommandArgument("player") target: Player,
        @CommandArgument("amount") amount: Double
    ) {
        val senderPlayer = sender as Player

        if (amount <= 0) {
            sender.sendError("invalidAmount", amount) // 按序传参
            return
        }

        if (getPlayerBalance(senderPlayer) < amount) {
            sender.sendError("insufficientFunds") // 错误消息
            return
        }

        // 执行转账
        transferMoney(senderPlayer, target, amount)

        // 成功消息（按序传参）
        sender.sendInfo("paySuccess", amount, target.name)
        target.sendInfo("payReceived", amount, sender.name)

        // 警告消息 (如果余额较低)
        if (getPlayerBalance(senderPlayer) < 1000) {
            sender.sendWarn("lowBalanceWarning")
        }
    }
}
```

## 注意事项
- 语言文件使用 UTF-8 编码
- **⚠️ 重要：占位符使用数字格式 `{0}`, `{1}`, `{2}`，而不是 `{key}` 格式**
- **⚠️ 重要：代码中使用按序传参，而不是键值对传参**
- **语言文件中使用 `&` 而不是 `§` 进行颜色代码，TabooLib 会自动转换**
- 支持 YAML 的多行文本和列表
- 未找到语言键时会显示键名
- 建议为所有用户可见的消息提供多语言支持
- 语言文件结构为扁平结构，使用小驼峰命名

## 常见错误和解决方案

### ❌ 错误 1：使用命名占位符
```yaml
# 错误
playerJoined: "玩家 {playerName} 加入了服务器"
```
```kotlin
// 错误
player.sendInfo("playerJoined", "playerName" to player.name)
```

### ✅ 正确 1：使用数字占位符
```yaml
# 正确
playerJoined: "玩家 {0} 加入了服务器"
```
```kotlin
// 正确
player.sendInfo("playerJoined", player.name)
```

### ❌ 错误 2：层级结构语言文件
```yaml
# 错误
messages:
  success:
    login: "登录成功"
  error:
    permission: "权限不足"
```

### ✅ 正确 2：扁平结构语言文件
```yaml
# 正确
messagesSuccessLogin: "登录成功"
messagesErrorPermission: "权限不足"
```

### 从其他插件迁移提示

如果你正在从使用命名占位符的插件迁移到 TabooLib I18n，需要：

1. **修改语言文件**：将所有 `{name}` 改为 `{0}`, `{1}`, `{2}` 等
2. **修改代码调用**：将 `"key" to value` 改为直接传递 `value`
3. **调整参数顺序**：确保参数按占位符顺序传递

**迁移工具建议**：可以写脚本批量替换，先处理语言文件，再处理代码调用。

## 实战示例：命令提示语整合

`example/command/1` 中的 `CommandProfile`、`CommandRoute` 演示了 Lang 模块与指令系统协作的完整流程。

### 消息文件组织
建议在 `resources/lang/` 下维护多语言文件，例如：
```yaml
# resources/lang/zh_CN.yml
command-magicpoint-add: "§a已为 {0} 增加 {1} 点灵力"
command-route-selected: "§e已切换至职业: {0}"
player-route-invalid: "§c当前尚未选择职业"
```
在 `en_US.yml` 中给出同名键的英文文案，即可支持实时切换。

### 指令内调用
```kotlin
player.sendLang("command-magicpoint-add", player.name, value)
player.sendLang("player-route-selected", route.name)
```
占位符 `{0}`、`{1}` 以顺序传参的方式替换上下文数据，避免手动拼接字符串；当需要在逻辑中复用文案时，可改用 `player.asLangText("command-magicpoint-add", player.name, value)` 获取字符串。

### 运行时语言控制
若插件内存在自定义 UI，可结合 `Language.setPlayerLanguage(player, "en_US")` 手动切换语言，或在登录事件中读取玩家偏好后调用，确保 `sendLang` 立即生效。

### 热重载与校验
开发阶段执行 `Language.reload()` 即可重新加载 `resources/lang/` 内全部文件，无需重启服务端。推荐将 `Language.hasKey(key)`、`Language.getTextWithLanguage(locale, key, args...)` 用于单元测试或命令诊断，提前发现缺失文案。

